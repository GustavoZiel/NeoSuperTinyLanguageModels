"""The main generate code"""

import hydra
import json5
import torch
from prettytable import PrettyTable

from models.build_models import build_model
from models.generator import StandardGenerator
from utils.logger import get_logger

logger = get_logger(__name__)

# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# |               Model                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Perplexities                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# | 20250929_0439_simple_en_wiki_10000 |              1.06,            208.23,            287.22,             25.03,            412.91,          19859.12,        1015135.88,           3330.94,             49.67,          73316.11,              1.01,             15.61,             22.70,              2.61,              3.60,          59260.29,  1000000389120.00,  1000000389120.00,              1.33,  1000000389120.00,             12.48,             31.42,              3.73,             49.57,             10.41,              1.94,        1000008.75,              7.16,              6.67,              1.82,              4.42,              1.86,        1000002.12,            438.13,        1005781.81,           5988.27,              3.15,  1000000389120.00,              1.13,        1000000.19,              1.00,              2.59,              1.23,             26.96,              1.01,             14.16,              1.23,              1.05,              1.04,  1000000389120.00 |
# | 20250929_0617_simple_en_wiki_20000 |             11.86,            322.30,            268.21,             11.58,            485.04,  1000000389120.00,              4.18,  1000000389120.00,              1.42,           6266.68,              1.07,            125.60,             22.71,              4.07,              3.75,          20028.70,            238.26,  1000000389120.00,              4.34,          15412.08,             30.71,            381.56,              2.68,             24.28,              5.36,              1.07,        1000198.56,             27.72,              1.05,            239.12,              4.98,             10.78,        1001416.44,            227.88,        1000115.56,           6929.08,  1000000389120.00,  1000000389120.00,            797.57,        1000000.19,              1.03,             26.60,              1.07,             10.16,              1.53,            215.40,              2.53,             20.41,              1.97,  1000000389120.00 |
# | 20250929_0756_simple_en_wiki_30000 |              1.08,          10981.09,            293.30,              8.66,            129.95,  1000000389120.00,              4.39,  1000000389120.00,              3.30,          47921.24,              1.01,             34.23,              1.15,              3.80,              6.24,          57474.02,              1.65,          15678.49,             10.36,  1000000389120.00,             19.73,            200.24,             77.48,            242.80,              2.91,              2.56,        1000035.50,            124.21,              1.45,              6.49,              1.07,            124.24,        1000774.88,            245.01,        1000135.62,  1000000389120.00,             29.74,  1000000389120.00,           1093.80,        1000000.19,              1.00,              5.37,              5.26,             37.12,              1.28,              4.40,              1.74,             53.22,              1.59,  1000000389120.00 |
# | 20250929_0936_simple_en_wiki_40000 |              1.01,           2054.93,            287.04,              3.89,             39.65,  1000000389120.00,        1000000.19,  1000000389120.00,              2.69,         154031.14,              1.11,              2.92,              1.02,              9.64,              1.82,          20251.09,            122.05,           7472.27,              5.73,  1000000389120.00,             16.61,            282.04,              7.74,             55.22,              1.78,             27.15,        1000174.75,            884.30,              1.04,            376.28,              1.09,             19.79,        1000057.38,        1130259.50,        1000004.94,  1000000389120.00,              5.58,  1000000389120.00,            208.47,        1000000.19,              1.00,             61.76,              1.26,             28.34,              1.02,            216.63,             81.49,              7.26,              1.22,  1000000389120.00 |
# | 20250929_1115_simple_en_wiki_50000 |              1.03,           7579.26,            313.88,              4.03,             15.11,  1000000389120.00,              6.77,  1000000389120.00,              4.92,         142024.28,              1.02,             56.87,              1.01,              9.94,              1.07,          31693.56,             42.87,          15171.81,              1.82,  1000000389120.00,             33.19,            123.90,              2.42,            341.98,              3.77,             43.54,             22.64,            883.71,              1.03,            313.28,              1.34,            111.39,        1000029.75,        1010796.44,        1000004.00,  1000000389120.00,             58.95,  1000000389120.00,  1000000389120.00,        1000000.19,              1.50,            197.17,              1.48,             44.65,              1.01,              9.47,             46.32,              2.88,              1.09,  1000000389120.00 |
# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# |               Model                |                                                                                                                                                                                                                                                    Perplexities                                                                                                                                                                                                                                                    |
# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# | 20250929_0439_simple_en_wiki_10000 |     2.78,    29.07,     3.62,     5.39,    33.08,   118.87,    11.00,    55.35,     8.58,   116.19,     1.65,     5.90,    11.67,     3.74,     7.89,   149.02,    67.15,   373.26,     5.06,   189.45,    10.06,    10.13,     9.57,    10.12,    18.16,     3.29,    12.56,     6.62,     6.56,     2.49,     8.36,     3.06,    33.80,    21.47,    24.96,    94.54,    12.23,   780.75,     2.84,    37.73,     1.50,     3.77,     3.09,     6.08,     1.66,    11.55,     3.73,     1.69,     3.70,   480.03 |
# | 20250929_0617_simple_en_wiki_20000 |     5.14,    29.79,     4.07,     4.47,    29.79,   196.75,     4.36,   239.97,     2.16,    38.93,     1.77,     8.83,     7.77,     5.09,     4.65,    70.85,    26.74,   300.41,     7.40,   121.25,    13.90,    33.03,     5.78,     6.92,    12.92,     1.80,    14.37,    12.61,     1.80,    14.97,     9.08,     9.30,    12.56,    14.33,     8.97,    88.74,    95.06,   425.95,    45.10,    52.21,     2.58,     7.97,     2.59,     3.41,     3.11,    24.80,     6.13,     5.99,     4.68,  1958.03 |
# | 20250929_0756_simple_en_wiki_30000 |     1.86,   119.46,     4.77,     4.16,    21.07,   351.34,     4.44,   236.59,     2.98,    83.04,     1.58,     6.19,     3.36,     4.65,    11.89,   139.78,     5.24,    81.38,    14.32,   480.38,    11.25,    22.36,    18.61,    14.85,     9.20,     4.38,    13.28,    23.64,     3.55,     4.34,     3.58,    14.60,    12.54,    21.59,    10.72,   148.46,    42.27,  1172.98,    50.33,    57.66,     1.53,     4.73,     8.16,     6.44,     5.16,     4.13,     6.42,     8.82,     6.89,   344.92 |
# | 20250929_0936_simple_en_wiki_40000 |     1.66,    72.86,     3.85,     3.75,    17.36,   560.67,     6.51,   237.67,     3.21,   134.87,     2.02,     2.53,     1.97,     7.96,     7.38,    94.77,    43.13,    58.12,    10.47,   277.90,    14.81,    34.93,    13.70,    10.08,     9.42,    15.03,     9.41,    55.42,     1.79,    20.52,     4.96,     6.30,    21.05,    27.98,    15.73,   311.01,    18.40,  2350.02,    25.22,    67.30,     1.88,    12.42,     5.16,     5.87,     1.88,    22.08,    36.04,     5.87,     5.74,   239.42 |
# | 20250929_1115_simple_en_wiki_50000 |     2.29,    91.98,     3.76,     3.44,    12.35,   276.76,     5.73,   247.89,     3.97,   128.09,     1.61,     6.58,     1.74,     7.27,     2.73,    92.15,    20.93,    70.01,     6.05,   180.53,    12.46,    21.11,     7.04,    15.67,    14.12,    12.78,     8.44,    37.89,     1.98,    15.20,     5.87,    11.95,    12.31,    25.26,    10.44,   248.46,    43.91,  4005.43,   125.61,   120.16,     6.59,    14.31,     6.89,     6.51,     1.83,     4.72,    13.73,     3.51,     3.14,   635.48 |
# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# |               Model                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Perplexities                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# | 20250929_0439_simple_en_wiki_10000 |              1.26,             40.30,              4.13,              9.02,             72.70,            762.94,        1050037.00,            229.96,             16.52,           1762.40,              1.08,              7.45,             10.39,              2.33,              3.83,           1542.60,             49.97,  1000000389120.00,              1.84,  1000000389120.00,              7.82,             11.72,              4.74,             15.73,             10.96,              2.08,        1000536.31,              5.40,              5.61,              1.94,              4.06,              2.02,        1000174.75,             67.75,        1044255.94,            349.66,              3.94,  1000000389120.00,              1.33,        1000005.88,              1.01,              2.47,              1.47,              9.72,              1.07,              7.46,              1.66,              1.19,              1.29,  1000000389120.00 |
# | 20250929_0617_simple_en_wiki_20000 |              6.02,             51.57,              5.54,              5.47,             72.81,           2246.28,              3.26,  1000000389120.00,              1.60,            342.00,              1.18,             25.99,              9.21,              3.25,              3.46,            741.11,             45.71,           5303.60,              4.18,            646.84,             13.18,             61.79,              3.26,              9.43,              6.45,              1.19,        1002799.31,             14.09,              1.19,             40.69,              4.41,              6.68,             27.48,             38.92,              8.99,            380.73,            106.91,  1000000389120.00,            110.51,        1000000.19,              1.16,              9.91,              1.27,              4.87,              1.79,             39.26,              2.96,              8.50,              2.24,  1000000389120.00 |
# | 20250929_0756_simple_en_wiki_30000 |              1.20,            512.46,            319.41,              4.60,             33.85,  1000000389120.00,              3.65,           2535.20,              2.71,           1321.94,              1.08,             11.40,              1.40,              3.10,              6.13,           1510.88,              2.26,            632.37,              8.68,  1000000389120.00,             10.79,             37.47,             26.86,             41.12,              3.86,              2.61,        1001388.75,             34.21,              1.83,              4.35,              1.31,             29.63,        1008817.38,             47.04,             15.82,            584.87,             23.52,  1000000389120.00,            125.59,        1000000.19,              1.02,              3.89,              4.82,             11.64,              1.70,              3.36,              2.40,             15.55,              2.43,  1000000389120.00 |
# | 20250929_0936_simple_en_wiki_40000 |              1.07,            169.69,              4.85,              2.85,             17.23,  1000000389120.00,              6.31,  1000000389120.00,              2.61,           2879.43,              1.30,              2.55,              1.11,              5.95,              2.77,            756.96,             49.53,            387.34,              5.96,  1000000389120.00,             11.51,             47.71,              7.87,             16.95,              3.00,             13.50,              9.49,            127.50,              1.16,             57.03,              1.46,              8.33,        1001753.62,             83.86,        1000361.69,  1000000389120.00,              6.69,  1000000389120.00,             40.80,        1000000.19,              1.05,             17.68,              1.79,              9.62,              1.09,             38.80,             33.76,              5.11,              1.80,  1000000389120.00 |
# | 20250929_1115_simple_en_wiki_50000 |              1.18,            395.44,              4.18,              2.86,             10.23,  1000000389120.00,              5.01,           3560.96,              3.72,           2726.91,              1.10,             15.63,              1.07,              6.15,              1.29,           1009.71,             20.14,            617.76,              2.63,           1103.40,             14.79,             27.46,              3.07,             50.99,              5.81,             15.58,             10.52,            111.37,              1.16,             47.71,              1.80,             25.02,             17.56,             94.46,        1000283.50,  1000000389120.00,             32.29,  1000000389120.00,            718.80,        1000000.19,              2.13,             35.53,              2.18,             12.86,              1.06,              5.25,             17.01,              2.79,              1.32,  1000000389120.00 |
# +------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# (.venv) ╭─ziel@Ziel ~/codes/SIPGA/SuperTinyLanguageModels ‹experiment/test-repo●›

# +------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# |               Model                |                                                                                                                                                                                                                                                                                                                                                                                                                                               Perplexities                                                                                                                                                                                                                                                                                                                                                                                                                                               |
# +------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
# | 20250929_0439_simple_en_wiki_10000 |              1.26,             40.30,              4.13,              9.02,             72.70,            762.94,        1050037.00,            229.96,             16.52,           1762.40,              1.08,              7.45,             10.39,              2.33,              3.83,           1542.60,             49.97,  1000000389120.00,              1.84,  1000000389120.00,              7.82,             11.72,              4.74,             15.73,             10.96,              2.08,        1000536.31,              5.40,              5.61,              1.94,              4.06,              2.02,              3.94,  1000000389120.00,              1.33,        1000005.88,              1.01,              2.47,              1.47,              9.72,              1.07,              7.46,              1.66,              1.19,              1.29,  1000000389120.00 |
# | 20250929_0617_simple_en_wiki_20000 |              6.02,             51.57,              5.54,              5.47,             72.81,           2246.28,              3.26,  1000000389120.00,              1.60,            342.00,              1.18,             25.99,              9.21,              3.25,              3.46,            741.11,             45.71,           5303.60,              4.18,            646.84,             13.18,             61.79,              3.26,              9.43,              6.45,              1.19,        1002799.31,             14.09,              1.19,             40.69,              4.41,              6.68,            106.91,  1000000389120.00,            110.51,        1000000.19,              1.16,              9.91,              1.27,              4.87,              1.79,             39.26,              2.96,              8.50,              2.24,  1000000389120.00 |
# | 20250929_0756_simple_en_wiki_30000 |              1.20,            512.46,            319.41,              4.60,             33.85,  1000000389120.00,              3.65,           2535.20,              2.71,           1321.94,              1.08,             11.40,              1.40,              3.10,              6.13,           1510.88,              2.26,            632.37,              8.68,  1000000389120.00,             10.79,             37.47,             26.86,             41.12,              3.86,              2.61,        1001388.75,             34.21,              1.83,              4.35,              1.31,             29.63,             23.52,  1000000389120.00,            125.59,        1000000.19,              1.02,              3.89,              4.82,             11.64,              1.70,              3.36,              2.40,             15.55,              2.43,  1000000389120.00 |
# | 20250929_0936_simple_en_wiki_40000 |              1.07,            169.69,              4.85,              2.85,             17.23,  1000000389120.00,              6.31,  1000000389120.00,              2.61,           2879.43,              1.30,              2.55,              1.11,              5.95,              2.77,            756.96,             49.53,            387.34,              5.96,  1000000389120.00,             11.51,             47.71,              7.87,             16.95,              3.00,             13.50,              9.49,            127.50,              1.16,             57.03,              1.46,              8.33,              6.69,  1000000389120.00,             40.80,        1000000.19,              1.05,             17.68,              1.79,              9.62,              1.09,             38.80,             33.76,              5.11,              1.80,  1000000389120.00 |
# | 20250929_1115_simple_en_wiki_50000 |              1.18,            395.44,              4.18,              2.86,             10.23,  1000000389120.00,              5.01,           3560.96,              3.72,           2726.91,              1.10,             15.63,              1.07,              6.15,              1.29,           1009.71,             20.14,            617.76,              2.63,           1103.40,             14.79,             27.46,              3.07,             50.99,              5.81,             15.58,             10.52,            111.37,              1.16,             47.71,              1.80,             25.02,             32.29,  1000000389120.00,            718.80,        1000000.19,              2.13,             35.53,              2.18,             12.86,              1.06,              5.25,             17.01,              2.79,              1.32,  1000000389120.00 |
# +------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


def _prepare_generator(model_filename, generator_cfg):
    model_path = hydra.utils.to_absolute_path(model_filename)
    logger.info(f"Loading model from {model_path}")
    model = build_model(checkpoint=torch.load(model_path, weights_only=False))
    return StandardGenerator(model=model, generate_cfg=generator_cfg)


# TODO Remover
def _handle_injected_evaluation(cfg, data: dict, generator=None):
    # input = {
    #     "memorization": [
    #         {
    #             "prompt": "On 23 October, 1977, Dennis Boone Gallagher was",
    #             "completion": " born",
    #         },
    #         {
    #             "prompt": "Catherine Wang Dominguez was born in",
    #             "completion": " Ethiopia",
    #         },
    #     ],
    #     "syntactic": [
    #         {
    #             "prompt": "was born in Jersey",
    #             "completion": " Clifford Johnson Houston",
    #         },
    #         {
    #             "prompt": "was born in Ethiopia",
    #             "completion": " Catherine Wang Dominguez",
    #         },
    #     ],
    # }

    # return {
    #     "injected": {
    #         "memorization": {
    #             "rank_average": 0.4455,
    #             "rank_std": 0.4831,
    #             "perplexity_average": 105.5603,
    #             "perplexity_std": 20.1234,
    #         }
    #     }
    # }
    res = {"injected": {}}
    for type in data.keys():
        logger.info(f"Evaluating injected prompts of type: {type}")
        res["injected"][type] = {}
        ranks = []
        perplexities = []
        for prompt in data[type]:
            _, perplexity = generator.evaluate_perplexity(
                prompt["prompt"],
                prompt["completion"],
                temperature=cfg["generator"]["temperature"],
                top_k=cfg["generator"]["top_k"],
            )
            _, avg_rank = generator.evaluate_rank(
                prompt["prompt"],
                prompt["completion"],
                temperature=cfg["generator"]["temperature"],
                top_k=cfg["generator"]["top_k"],
            )
            ranks.append(avg_rank)
            perplexities.append(perplexity)
            logger.info(
                f"Prompt: {prompt['prompt']}\n"
                f"Completion: {prompt['completion']}\n"
                f"Perplexity: {perplexity:.4f}\n"
                f"Average Rank: {avg_rank}\n"
            )
        avg_rank = sum(ranks) / len(ranks)
        avg_perplexity = sum(perplexities) / len(perplexities)
        logger.info(
            f"Type: {type} - Average Rank: {avg_rank:.4f}, Average Perplexity: {avg_perplexity:.4f}"
        )
        res["injected"][type]["rank_average"] = avg_rank
        res["injected"][type]["perplexity_average"] = avg_perplexity

    return res


def calculate_table(prompt_dict, column_name):
    max_value = max(
        max(row) if isinstance(row, (list, tuple, set)) else row
        for row in prompt_dict.values()
    )

    space = len(str(int(abs(max_value)))) + 4

    table = PrettyTable()
    table.field_names = ["Model", column_name]

    for model, values in prompt_dict.items():
        # Ensure values is always iterable
        if not isinstance(values, (list, tuple, set)):
            values = [values]

        formatted = ", ".join(f"{v:{space}.2f}" for v in values)
        table.add_row([model, formatted])

    return table


@hydra.main(config_path="../configs", config_name="generate", version_base=None)
def main(cfg):
    """Run the main eval loop"""
    # logger.info(f"Generation config:\n{cfg}")

    # logger.info(cfg["generator"]["inject_filepath"])

    # inject_filepath = cfg["generator"]["inject_filepath"]
    # with open(inject_filepath, "r") as f:
    #     data = json5.load(f)
    # print(data)

    if "input_prompts" in cfg["generator"]:
        prompts = cfg["generator"]["input_prompts"]
        average_evals = {}
        perplexity_dict = {}
        ranks_dict = {}
        for i_model, model_filename in enumerate(cfg["model_ckpts"], start=1):
            model_name = model_filename.split("/")[-1].rsplit(".", 1)[0]

            ranks_dict[model_name] = []
            perplexity_dict[model_name] = []
            average_evals[model_name] = {"perplexity": [], "rank": []}

            generator = _prepare_generator(model_filename, cfg["generator"])
            logger.info("Prompting model from config file input prompts.")
            print(
                "\n\n"
                + "=" * 30
                + f" Prompting {i_model}º: {model_name} "
                + "=" * 30
                + "\n\n"
            )

            generated = ""
            for prompt_num, prompt in enumerate(prompts, start=1):
                generated_text, messages = generator.default_generate(
                    input_text=prompt["sentence"]
                )
                probs, perplexity = generator.evaluate_perplexity(
                    prompt["sentence"],
                    prompt["answer"],
                    temperature=cfg["generator"]["temperature"],
                    top_k=cfg["generator"]["top_k"],
                )
                ranks, avg_rank = generator.evaluate_rank(
                    prompt["sentence"],
                    prompt["answer"],
                    temperature=cfg["generator"]["temperature"],
                    top_k=cfg["generator"]["top_k"],
                )

                ranks_dict[model_name].append(avg_rank)
                perplexity_dict[model_name].append(perplexity)

                generated += (
                    f"Question {prompt_num}\n\n"
                    f"Prompt:\n{prompt['sentence']}\n\n"
                    f"Generated:\n{generated_text[0]}\n\n"
                    f"Answer:\n{prompt['answer']}\n\n"
                    f"Probability of correct answer: {probs}\n"
                    f"Perplexity of correct answer: {perplexity:.4f}\n"
                    f"Rank of correct answer: {ranks}\n"
                    f"Average rank: {avg_rank:.4f}\n\n"
                )
                generated += generator._format_messages(
                    messages, cfg["generator"]["steps_to_log"]
                )
                generated += "=" * 30 + "\n\n"

            print(generated)
            print("=" * 30 + f" Finished {i_model}º: {model_name} " + "=" * 30 + "\n\n")

            avg_rank = sum(ranks_dict[model_name]) / len(ranks_dict[model_name])
            avg_perplexity = sum(perplexity_dict[model_name]) / len(
                perplexity_dict[model_name]
            )

            average_evals[model_name]["rank"] = avg_rank
            average_evals[model_name]["perplexity"] = avg_perplexity

        # print(average_evals)

        perplexity_average = {
            model: vals["perplexity"] for model, vals in average_evals.items()
        }
        ranks_average = {model: vals["rank"] for model, vals in average_evals.items()}

        # print(perplexity_average)
        # print(ranks_average)

        perplexity_avg_table = calculate_table(
            perplexity_average, column_name="Average Perplexities"
        )
        rank_avg_table = calculate_table(ranks_average, column_name="Average Ranks")
        perplexity_table = calculate_table(perplexity_dict, column_name="Perplexities")
        rank_table = calculate_table(ranks_dict, column_name="Ranks")

        logger.info("Perplexity Results:")
        print(perplexity_table)
        logger.info("Rank Results:")
        print(rank_table)
        logger.info("Average Perplexities Results:")
        print(perplexity_avg_table)
        logger.info("Average Ranks Results:")
        print(rank_avg_table)

    else:
        logger.info("Prompting model from user input. Type 'exit' or 'quit' to stop.")
        while True:
            input_text = input("Enter the input text: ")
            if input_text.lower() in ["exit", "quit"]:
                logger.info("Exiting...")
                break
            for i_model, model_filename in enumerate(cfg["model_ckpts"], start=1):
                generated = ""
                model_name = model_filename.split("/")[-1].rsplit(".", 1)[0]
                generator = _prepare_generator(model_filename, cfg["generator"])
                generated_text, messages = generator.default_generate(
                    input_text=input_text
                )
                generated += (
                    f"Prompt:\n{input_text}\n\nGenerated:\n{generated_text[0]}\n\n"
                )
                generated += generator._format_messages(
                    messages, cfg["generator"]["steps_to_log"]
                )
                generated += "=" * 30 + "\n\n"

                print(
                    "\n\n"
                    + "=" * 30
                    + f" Prompting {i_model}º: {model_name} "
                    + "=" * 30
                    + "\n\n"
                )
                print(generated)
                print(
                    "=" * 30
                    + f" Finished {i_model}º: {model_name} "
                    + "=" * 30
                    + "\n\n"
                )


if __name__ == "__main__":
    main()
